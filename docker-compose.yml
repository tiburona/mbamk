version: '3'

services:
 web:
   restart: always
   build: ./cookiecutter_mbam
   image: mbam_web
   environment:
     - "PYTHONUNBUFFERED=1"
   volumes:
     - user-data:/app/cookiecutter_mbam/static/files
     - assets-data:/app/cookiecutter_mbam/static/build
   command: bash -c "cp .docker_env .env && npm run build && flask run"
   depends_on:
     - jatos

 jatos:
   restart: always
   build: ./jatos
   expose:
    - "9000"
   volumes:
    - jatos-data:/opt/docker
   # env_file:
   #  - .env

 nginx:
   restart: always
   build:
     context: ./nginx
     args:
       - NGINX_CONFIG_FILE=${NGINX_CONFIG_FILE}
   ports:
     - "80:80"
     - "443:443"
   volumes:
     - user-data:/app/cookiecutter_mbam/static/files
     - assets-data:/app/cookiecutter_mbam/static/build
   depends_on:
     - web

 redis:
   image: 'redis:5.0.3-alpine'
   command: redis-server
   volumes:
    - 'redis-data:/data'
   ports:
    - '6379:6379'

 celery:
   image: mbam_web
   command: celery -A cookiecutter_mbam.run_celery:celery worker --loglevel info
   links:
    - redis

volumes:
  jatos-data:
  user-data:
  assets-data:
  redis-data:
