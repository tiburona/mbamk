version: '3'

services:
 web:
   restart: always
   build: ../..
   image: mbam_web
   volumes:
     - user-data:/app/static/files
     - assets-data:/app/static/build
     - static-data:/app/static
   command: python tools/start/entry.py run --flask --mysql docker --env docker
   depends_on:
     - jatos
   environment:
     PYTHONUNBUFFERED: 1
     PARAMETER_STORE_KEY_ID: ${AWS_KEY_ID}
     PARAMETER_STORE_SECRET_KEY: ${AWS_SECRET_KEY}

 jatos:
   restart: always
   build: ./jatos
   expose:
    - "9000"
   volumes:
    - jatos-data:/opt/docker

 nginx:
   restart: always
   build:
     context: ./nginx
   ports:
     - "80:80"
     - "443:443"
   volumes:
     - user-data:/app/static/files
     - assets-data:/app/static/build
     - static-data:/app/static
   depends_on:
     - web

 redis:
   image: 'redis:5.0.3-alpine'
   command: redis-server
   volumes:
    - 'redis-data:/data'
   ports:
    - '6379:6379'

 celery:
   image: mbam_web
   command: python tools/start/entry.py run --celery  --mysql docker --env docker
   volumes:
     - user-data:/app/static/files
   links:
    - redis
   environment:
    # CONFIG_NAME: 'docker'
    # XNAT_HOST: ${XNAT_HOST}
    # XNAT_USER: ${XNAT_USER}
    # XNAT_PASSWORD: ${XNAT_PASSWORD}
    # XNAT_PROJECT: ${XNAT_PROJECT}
    # DOCKER_HOST: ${XNAT_DOCKER_HOST}
    # DICOM_TO_NIFTI_COMMAND: ${DICOM_TO_NIFTI_TRANSFER_COMMAND_ID}
    # CLOUDFRONT_PRIVATE_KEY: ${CLOUDFRONT_PRIVATE_KEY}
      PARAMETER_STORE_KEY_ID: ${AWS_KEY_ID}
      PARAMETER_STORE_SECRET_KEY: ${AWS_SECRET_KEY}


volumes:
  jatos-data:
  user-data:
  assets-data:
  redis-data:
  static-data:
