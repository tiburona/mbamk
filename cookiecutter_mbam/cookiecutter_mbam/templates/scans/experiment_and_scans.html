{% extends "layout.html" %}

{% block content %}

<br>
<br>
<br>

<div class="container-narrow">
    {% if action == "new" %}
          <h3>New Scan Upload</h3>
          <p>For the best experience use Chrome or Opera browser. Firefox is also supported. Internet Explorer and Safari are not.</p>
          <br>
          <label for="input-cd-step1">If you have your scan on a CD, please insert it and select the drive using the "Browse" button. You may also select a folder with dicom files.</label>
          <div class="file-loading">
              <input id="input-cd-step1" name="input-cd-step1[]" type="file" multiple mozdirectory webkitdirectory>
          </div>
          <div id="errorBlock-cd" class="help-block"></div>
          <p><br></p>
          <h4>Or...</h4>
          <p><br></p>
          <label for="input-file">If you already have it, you may also select a NIFTI file or a zipped folder of DICOM files.</label>
          <div class="file-loading">
              <input id="input-file" name="input-file" type="file" multiple>
          </div>
          <div id="errorBlock-file" class="help-block"></div>

    {% endif %}

    <!-- Below is CD-Modal #1 -->
    <div class="modal fade" id="pleaseWaitDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Scanning files...</h2>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                            <span class="sr-only">40% Complete (success)</span>
                        </div>
                    </div>
                    <div><button class="btn btn-default start-over">Cancel</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Below is CD-Modal #2 -->
    <div class="modal fade" id="compareScanDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="overflow-y: scroll; max-height:85%;  margin-top: 50px; margin-bottom:50px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Scans we found on your CD/folder.</h4>
                    <h5>We found one or more structural MRI scans. Please select up to 3 scans that look similar to one or more sample images shown at the bottom.
                     If you have multiple options, we recommend selecting scans with the most number of slices and with a range of acquisition view types (i.e. axial, sagittal and coronal).</h5>
                </div>
                <div class="modal-body">
                    <div class="file-loading">
                        <input id="input-cd-step2" name="input-cd-step2[]" type="file" multiple>
                    </div>
                    <button class="btn btn-success" id="next-button">Next</button>
                    <button class="btn btn-default start-over">Start Over</button>
                    <hr>
                    <h4>Sample images</h4>
                    <div>
                        <input id="sample-images" name="sample-images[]" type="file" multiple>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Below is the final submit form where CD folder and file input options converge -->
    {% if action == "new" %}
        <div class="modal fade" id="finalSubmitDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="overflow-y: scroll; max-height:85%;  margin-top: 50px; margin-bottom:50px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>New Scan Upload</h3>
                        <h5>If it's not already filled in, please provide the date of the scan before clicking the upload button. You also have the option to provide the model and
                        field strength of the scanner if you know them.</h5>
                        <div class="modal-body">
                            <!-- below was copied from the old upload form -->
                            {% from "security/_macros.html" import render_field, render_field_with_errors %}
                            <form method="POST" action="{{ url_for('scan.add_experiment_and_scans') }}" enctype="multipart/form-data" role="form" id="uploadForm">
                            {{ form.hidden_tag() }}
                            {{ render_field(form.date, class='form-control') }}
                            {{ render_field(form.scanner, class='form-control') }}
                            {{ render_field(form.field_strength, class='form-control') }}
                            <div style="display: none;">
                                {{ render_field(form.scan_file, class='form-control') }}
                            </div>
                            <button type="submit" class="btn btn-success submit-button" id="upload-toggle">Upload</button>
                            <button id="go-back" class="btn btn-default" onclick="return false;">Go Back</button>
                            <button type="button" class="btn btn-default start-over" onclick="return false;">Cancel</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% elif action == "edit" %}
        <div class="col-md-offset-3 col-md-6">
            <h3>Edit Scan Metadata</h3>
            <form method="POST" action="{{ url_for('edit', scan_number=current_user.scans.first().scan_number) }}" enctype="multipart/form-data" role="form">
            {% from "security/_macros.html" import render_field, render_field_with_errors %}
            {{ form.hidden_tag() }}
            {{ render_field(form.date, class='form-control') }}
            {{ render_field(form.scanner, class='form-control') }}
            {{ render_field(form.field_strength, class='form-control') }}
            <div style="display: none;">
                {{ render_field(form.scan_file, class='form-control') }}
            </div>
            <button type="submit" class="btn btn-success custom-width">Update</button>
            <a href="{{ url_for('volume_view', session_number=current_user.sessions.first().session_number, viewType='struct_subjectSpace') }}" class="btn btn-default">Cancel</a>
            </form>
        </div>
    <!-- below form without modals for "legacy" upload form -->
    {% elif action == "old" %}
        <div class="col-md-offset-3 col-md-6">
            <h3>New Scan Upload</h3>
            <form method="POST" action="{{ url_for('scan.add_experiment_and_scans') }}" enctype="multipart/form-data" role="form" id="uploadForm">
            {% from "security/_macros.html" import render_field, render_field_with_errors %}
            {{ form.hidden_tag() }}
            {{ render_field(form.date, class='form-control') }}
            {{ render_field(form.scanner, class='form-control') }}
            {{ render_field(form.field_strength, class='form-control') }}
            {{ render_field(form.scan_file, class='form-control') }}
            <button type="submit" class="btn btn-success custom-width" id="upload-toggle">Upload</button>
            <a href="{{ url_for('index') }}" class="btn btn-default">Cancel</a>
            </form>
        </div>
    {% endif %}

    <!-- Below is FinalUploadWait Dialog -->
    <div class="modal fade" id="uploadWaitDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="text-center">Uploading...</h2>
                    <h4>We appreciate your patience as your MRI scan is being uploaded and archived. This may take several minutes. If successful,
                    you will be directed to a page where you can view your MRI scan in the browser.</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="center-block" style="width:150px;">
                            <div class="upload-progress">
                                <div>Loading...</div>
                            </div>
                        <div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Below is error/exception Dialog -->
    <div class="modal fade" id="errorMsgDialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<h2 class="text-center">Error</h2>-->
                    <h4>Oops! Something went wrong, try starting over.</h4>
                    <a href="{{ url_for('scan.add_experiment_and_scans') }}" class="btn btn-default">OK</a>
                </div>
            </div>
        </div>
    </div>

</div>

{% endblock %}
